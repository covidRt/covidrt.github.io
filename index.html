<!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>COVID Rt</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3"></script>
  </head>
  <body>

    <p id=para><font size="80px"></font></p>
    <canvas id="myChart" width="400" height="200"></canvas>


    
  <script>
  const endpoint = 'https://api.covidtracking.com/v1/states/ca/daily.json';

  getData();
  const date = [];
  const dailyNewCases = [];
  const sevenDaysAve = [];
  const sumFourtenn = [];
  const Rt = [];
  const cummulateError = [
    0.037, 0.138, 0.160, 0.142, 0.117, 0.094, 0.075, 0.059, 0.047, 0.038, 0.031, 0.025, 0.021, 0.017
  ]


  chartIt();

  async function chartIt(){
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: date,
                datasets: [{
                    label: '実行再生産数',
                    data: Rt,
                    fill:false,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
              scales: {
               xAxes: [{
                ticks: {
                    reverse: true
                }
            }]
        }
    }
          });
      }



  async function getData(){
    const response = await fetch(endpoint);
    const json = await response.json();
    for (let i = 0; i < 90; ++i){
       date.push(json[i+1].date)
    }
    for (let i = 0; i < 120; ++i){
       dailyNewCases.push(json[i].positiveIncrease)
    }
    sevenD();
    calculateErr();
    calculateRt();
    paraG();
  }
  

  function sevenD(){
    for(let i = 0; i < 120; ++i){
      sevenDaysAve.push(
        (dailyNewCases.slice(i, i+7).reduce((acc, cur) => acc + cur)) / 7)
    }
  }

  function calculateErr(){
    for(let i = 0; i < 120; ++i){
      let sevenSlice = sevenDaysAve.slice(i);
      const arr = [];
      for(let i =0; i<14; ++i){
          const x = sevenSlice[i+1] * cummulateError[i];
          arr.push(x);
      }
    sumFourtenn.push(arr.reduce((acc, cur) => acc + cur))
  }}

  function calculateRt(){
    for(let i = 0; i < 90; ++i){
      Rt.push(Math.floor(sevenDaysAve[i]/sumFourtenn[i]*1000)/1000);
    }
  }

  async function paraG(){
    document.getElementById('para').innerText =
    ` ${date[0]}時点
      カリフォルニア州
      実行再生産数: ${Rt[0]}
      新規感染者（7日間平均）：${Math.floor(sevenDaysAve[0]*10)/10}`
  }
    
  

  </script>
  </body>
  </html>
